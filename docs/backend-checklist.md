# バックエンド実装状況チェックリスト

## 🎯 プロジェクトの目的
推し（Vtuber、アイドル等）の誕生日を祝うためのクラウドファンディングプラットフォーム。
ファンが連携して駅広告やデジタルサイネージなどにお誕生日広告を出すことのできるサービス。

## 💻 技術スタック
- **言語**: Go (Golang) 1.21
- **フレームワーク**: Gin
- **データベース**: PostgreSQL 16
- **ORM**: GORM v2
- **認証**: JWT
- **開発ツール**: Air（ホットリロード）
- **コンテナ化**: Docker & Docker Compose
- **ログ管理**: Zap
- **バリデーション**: validator/v10

## 📁 プロジェクト構成

```
backend/
├── cmd/
│   ├── main.go          # メインエントリーポイント
│   └── migrate.go       # マイグレーションコマンド
├── internal/
│   ├── db/
│   │   ├── connection.go  # DB接続管理
│   │   └── migrations/    # データベースマイグレーション
│   ├── handlers/          # APIハンドラー
│   │   ├── auth_handler.go     # 認証関連
│   │   ├── user_handler.go     # ユーザー関連
│   │   ├── project_handler.go  # プロジェクト関連
│   │   └── support_handler.go  # 支援関連
│   ├── middleware/        # ミドルウェア
│   │   ├── auth.go       # 認証ミドルウェア
│   │   ├── cors.go       # CORS設定
│   │   └── logger.go     # ロギング
│   ├── models/           # データモデル
│   │   ├── user.go      # ユーザーモデル
│   │   ├── project.go   # プロジェクトモデル
│   │   └── support.go   # 支援モデル
│   └── utils/           # ユーティリティ関数
│       ├── auth.go      # 認証ユーティリティ
│       ├── response.go  # レスポンスヘルパー
│       ├── validator.go # バリデーションヘルパー
│       └── errors.go    # エラー定義
├── vendor/              # 依存パッケージ
├── .env                 # 環境変数
├── .air.toml           # ホットリロード設定
├── Dockerfile          # 開発環境用Dockerfile
├── Dockerfile.prod     # 本番環境用Dockerfile
├── docker-compose.yml  # Docker Compose設定
├── go.mod             # Go モジュール定義
└── go.sum             # 依存関係のチェックサム
```

## ✅ 実装済み機能

### 🔐 認証・認可
- [x] JWTベースの認証システム
  - [x] トークンの生成と検証
  - [x] リフレッシュトークンの実装
  - [x] トークンの有効期限管理
  - [x] トークンのブラックリスト管理
- [x] ミドルウェアによる認証チェック
- [x] 保護されたルートの実装
- [x] パスワードのハッシュ化と検証（bcrypt）
- [x] ユーザー登録・ログイン機能
- [x] Cookie認証の実装

### 🎯 コアビジネスロジック
- [x] プロジェクト管理（CRUD操作）
  - [x] プロジェクトの作成
  - [x] プロジェクトの更新
  - [x] プロジェクトの削除
  - [x] プロジェクト一覧の取得（ページネーション対応）
  - [x] プロジェクト詳細の取得
  - [x] プロジェクトの検索・フィルタリング
  - [x] プロジェクトのステータス管理
  - [x] プロジェクトの承認フロー
- [x] サポート（支援）機能
  - [x] 支援情報の登録
  - [x] 支援履歴の取得
  - [x] 支援統計の集計
  - [x] 支援メッセージの管理
- [x] お気に入り機能
  - [x] お気に入りの追加・削除
  - [x] お気に入り一覧の取得
- [x] タグ管理機能
  - [x] タグの作成・更新・削除
  - [x] タグによるプロジェクトのフィルタリング

### 🛠 技術基盤
- [x] データベースマイグレーション
  - [x] マイグレーションファイルの整理
  - [x] マイグレーションコマンドの実装
  - [x] ロールバック機能
- [x] GORM統合
  - [x] モデル定義
  - [x] リレーションの設定
  - [x] カスタムバリデーション
  - [x] トランザクション管理
- [x] エラーハンドリング
  - [x] 統一されたエラーレスポンス形式
  - [x] パニックリカバリー
  - [x] カスタムエラータイプ
  - [x] バリデーションエラーの整形
  - [x] エラーログの構造化
- [x] CORS設定
  - [x] 環境変数による設定
  - [x] 複数オリジンの許可
  - [x] クレデンシャルの許可
- [x] Docker対応
  - [x] 開発環境の整備
  - [x] 本番環境用の設定
  - [x] マルチステージビルド
- [x] 環境変数管理
  - [x] 開発環境と本番環境の分離
  - [x] 機密情報の管理
- [x] ホットリロード（Air）
- [x] ロギング
  - [x] 構造化ログ（Zap）
  - [x] リクエスト/レスポンスのログ
  - [x] エラーログの収集
  - [x] ログレベルの管理

## 🔄 進行中の機能

### 💳 決済機能（優先度：高）
- [ ] Stripe APIの統合
  - [ ] 決済インテント作成
  - [ ] 支払い方法の保存
  - [ ] サブスクリプション管理
  - [ ] Webhookハンドラーの実装
- [ ] 決済フローの実装
  - [ ] 支援金額の検証
  - [ ] 決済状態の管理
  - [ ] 失敗時のリトライ
  - [ ] 支援完了通知
- [ ] 支援金額の管理機能
  - [ ] 集計機能
  - [ ] レポート生成
  - [ ] 支援履歴の管理

### 🔒 セキュリティ強化（優先度：高）
- [ ] レート制限の実装
  - [ ] IPベースの制限
  - [ ] ユーザーベースの制限
  - [ ] エンドポイントごとの制限
- [ ] セキュリティヘッダーの設定
  - [ ] HSTS
  - [ ] CSP
  - [ ] X-Frame-Options
- [ ] 入力値の検証強化
  - [ ] カスタムバリデーション
  - [ ] サニタイズ処理
  - [ ] XSS対策
- [ ] CSRF対策の実装
- [ ] 監査ログの実装

### 🧪 テスト（優先度：高）
- [ ] ユニットテスト
  - [ ] ハンドラーのテスト
  - [ ] ミドルウェアのテスト
  - [ ] ユーティリティ関数のテスト
  - [ ] モデルのテスト
- [ ] 統合テスト
  - [ ] APIエンドポイントのテスト
  - [ ] データベース操作のテスト
  - [ ] 認証フローのテスト
- [ ] モックの作成
  - [ ] データベースモック
  - [ ] 外部APIモック（Stripe等）
  - [ ] サービスモック
- [ ] パフォーマンステスト
  - [ ] 負荷テスト
  - [ ] ストレステスト
  - [ ] メモリリークテスト

### 🚀 パフォーマンス最適化（優先度：中）
- [ ] キャッシュ戦略
  - [ ] Redisの導入
  - [ ] キャッシュポリシーの設定
  - [ ] キャッシュの無効化
- [ ] N+1問題の対処
  - [ ] Eager Loading
  - [ ] クエリの最適化
  - [ ] インデックスの最適化
- [ ] コネクションプール
  - [ ] データベース接続の最適化
  - [ ] コネクション数の調整
- [ ] クエリパフォーマンス
  - [ ] クエリの分析
  - [ ] インデックスの追加
  - [ ] クエリの書き換え

### 📊 監視・ロギング（優先度：中）
- [ ] APM導入
  - [ ] New Relic
  - [ ] Datadog
  - [ ] トレース機能
- [ ] メトリクス収集
  - [ ] Prometheusの導入
  - [ ] Grafanaでの可視化
  - [ ] カスタムメトリクス
- [ ] アラート設定
  - [ ] エラー率
  - [ ] レスポンスタイム
  - [ ] リソース使用率
  - [ ] カスタムアラート

## 📝 API仕様

### 認証関連
```
POST /api/register    # ユーザー登録
POST /api/login      # ログイン
POST /api/logout     # ログアウト
GET  /api/me         # 現在のユーザー情報取得
```

### プロジェクト関連
```
GET    /api/projects           # 一覧取得（公開）
GET    /api/projects/:id      # 詳細取得（公開）
POST   /api/projects          # 作成（要認証）
PUT    /api/projects/:id      # 更新（要認証）
DELETE /api/projects/:id      # 削除（要認証）
GET    /api/projects/my       # 自分のプロジェクト一覧（要認証）
```

### サポート関連
```
POST   /api/supports          # 支援作成（要認証）
GET    /api/supports/my       # 自分の支援一覧（要認証）
GET    /api/projects/:id/supports  # プロジェクトの支援一覧
```

### お気に入り関連
```
POST   /api/favorites/:id     # お気に入り追加（要認証）
DELETE /api/favorites/:id     # お気に入り削除（要認証）
GET    /api/favorites        # お気に入り一覧取得（要認証）
```

## 🔧 環境変数
必要な環境変数の詳細は[README.md](../readme.md#環境変数)を参照してください。

## 🚀 開発環境のセットアップ

### バックエンド固有の開発コマンド
```bash
# マイグレーションの実行
docker compose exec backend go run cmd/main.go -migrate

# テストの実行
docker compose exec backend go test ./...

# APIの動作確認
curl http://localhost:8000/health

# ユーザー登録例
curl -X POST http://localhost:8000/api/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password"}'
```

基本的な開発環境のセットアップ手順は[README.md](../readme.md#開発環境のセットアップ)を参照してください。

## 🚀 本番環境へのデプロイ
デプロイ手順の詳細は[deploy.md](./deploy.md)を参照してください。

### サーバーメンテナンス

#### ログの確認
```bash
# アプリケーションログ
tail -f ~/app/app.log

# エラーログ
tail -f ~/app/error.log
```

#### バックアップ
```bash
# データベースバックアップ
pg_dump -U [ユーザー名] [データベース名] > backup_$(date +%Y%m%d).sql
```

## 📋 次のステップ（優先順位順）

1. 🔒 セキュリティ強化
   - レート制限の実装
   - セキュリティヘッダーの設定
   - 各種セキュリティ対策の確認

2. 🧪 テストの実装
   - ユニットテストの作成
   - 統合テストの作成
   - CIでのテスト自動化

3. 📊 監視・ロギングの導入
   - 構造化ログの実装
   - メトリクス収集の設定
   - エラー監視の導入

4. 🚀 パフォーマンス最適化
   - キャッシュの導入
   - クエリの最適化
   - N+1問題の解決

## 🔍 トラブルシューティング

### よくある問題と解決方法

1. データベース接続エラー
```bash
# 接続確認
psql -h $DB_HOST -U $DB_USER -d $DB_NAME

# ファイアウォール設定確認
sudo ufw status
```

2. マイグレーションエラー
```bash
# マイグレーション状態確認
go run cmd/main.go -migrate status

# マイグレーションのロールバック
go run cmd/main.go -migrate down
```

3. APIエラー
```bash
# ログの確認
tail -f app.log

# サーバー状態確認
ps aux | grep app
``` 